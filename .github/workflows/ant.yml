# This workflow will build a Java project with Ant and upload the JAR artifact.
# After a successful run it will delete older artifacts with the same artifact name,
# so only the newest "Package" artifact remains.
# Note: To allow deleting artifacts the workflow needs an elevated permission for actions (write).
name: Java CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install ant, unzip, jq
        run: |
          sudo apt-get update
          sudo apt-get install -y ant unzip jq

      - name: Prepare lib directory
        run: mkdir -p lib

      - name: Find latest Utils artifact (hartrusion/Utils)
        id: find_artifact
        env:
          API_REPO: "hartrusion/Utils"
          TOKEN: ${{ github.token }}
        run: |
          set -e
          echo "Searching artifacts in repo: ${API_REPO}"
          API="https://api.github.com/repos/${API_REPO}/actions/artifacts"
          ARTIFACT_ID=$(curl -s -H "Authorization: token ${TOKEN}" "${API}" | jq -r '.artifacts[] | select(.expired==false) | .id' | head -n1)
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
            echo "No artifact found in ${API_REPO}"
            exit 1
          fi
          echo "artifact_id=${ARTIFACT_ID}" >> $GITHUB_OUTPUT
          echo "Found artifact id: $ARTIFACT_ID"

      - name: Download artifact zip
        env:
          API_REPO: "hartrusion/Utils"
          TOKEN: ${{ github.token }}
        run: |
          set -e
          ART_ID=${{ steps.find_artifact.outputs.artifact_id }}
          echo "Downloading artifact $ART_ID from ${API_REPO}..."
          ZIP_URL="https://api.github.com/repos/${API_REPO}/actions/artifacts/${ART_ID}/zip"
          curl -L -H "Authorization: token ${TOKEN}" -o artifact.zip "$ZIP_URL"
          echo "Downloaded artifact.zip"
          unzip -l artifact.zip

      - name: Extract Package.zip and utils.jar
        run: |
          set -e
          # Pr√ºfe, ob Package.zip im Artifact vorhanden ist
          if ! unzip -l artifact.zip | awk '{print $4}' | grep -q '^Package.zip$'; then
            echo "Package.zip not found inside artifact.zip"
            exit 1
          fi
          # Extrahiere Package.zip aus artifact.zip
          unzip -j -o artifact.zip 'Package.zip' -d . || (echo "Failed to extract Package.zip" && exit 1)
          if [ ! -f Package.zip ]; then
            echo "Extraction failed: Package.zip missing"
            exit 1
          fi
          # Extrahiere utils.jar aus Package.zip nach lib/
          if ! unzip -l Package.zip | awk '{print $4}' | grep -q '^utils.jar$'; then
            echo "utils.jar not found inside Package.zip"
            exit 1
          fi
          unzip -j -o Package.zip 'utils.jar' -d lib || (echo "Failed to extract utils.jar from Package.zip" && exit 1)
          echo "Extracted lib/utils.jar"
          ls -la lib

      - name: Run Ant build
        run: ant -buildfile .github/build.xml jar

      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Package
          path: build/jar/*.jar
          # optional: if-no-files-found: warn
